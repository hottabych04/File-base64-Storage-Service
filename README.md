# Тестовое задание для отбора на CaseLab от Росатом
## Условие задания
### Задача:
Необходимо реализовать микросервис, который будет выполнять роль хранилища различных файлов
и их атрибутов.

Микросервис должен предоставлять HTTP API и принимать/отдавать запросы/ответы в формате JSON.

Разработка UI-интерфейса не требуется. Для тестирования можно использовать Postman или аналог.

Должны быть реализованы следующие API-методы:

1. Создание файла.

На вход методу отправляется JSON, включающий в себя файл (в формате base64) и его атрибуты (название - 
title, дата и время отправки - creation_date, краткое описание документа - description), на выходе метод
возвращает id созданного файла.

2. Получение файла.

На вход методу отправляется id файла, на выходе метод возвращает JSON,
включающий в себя файл (в формате base64) и его атрибуты (название - title,
дата и время отправки - creation_date, краткое описание документа -
description)

### Технологический стек

Микросервис должен быть реализован на Java+Spring Boot, но допускается использование и дополнительных
библиотек.

Для хранения данных (и самого файла, и его атрибутов) использовать СУБД PostgreSQL.

Дополнительные требования (их реализовывать необязательно, но если сможешь реализовать какие-то
пункты - будет очень круто, мы это отметим как преимущество):

1. Добавить метод получения списка всех файлов (и их атрибутов). Необходимо реализовать пагинацию и
сортировку по времени создания файлов.
2. Покрыть проект тестами на JUnit.
3. Обернуть микросервис в docker-контейнер (можно в один вместе с БД).

## Автор решения

Бабиченко Илья Станиславович

## Описание реализации

Для решения, помимо перечисленных выше Java+Spring Boot, так же использовались такие библиотеки: Spring
Web (для создания слоя контроллеров и эндпоинтов), Spring Data JPA (для работы с БД и сущностями),
Liquibase (для реализации миграции БД), JUnit 5 (для тестов), Spring Boot Starter Test (для реализации интеграционного 
тестирования), Testcontainers (для создания тестовой БД). В качестве СУБД использовался PostgreSQL как и 
было указанно в условии.

### База данных

- Вся инициализация необходимой структуры в БД полностью автомитизированна при помощи библиотеки Liquibase.
Файлы и скрипты для инициализации и изменения таблиц лежат в директории `src/main/resources/db/changelog`
  * Основной файл с перечисленными скриптами для выполнения называется `db.changelog-master.yaml`
  * Для хранения в БД файлов и их атрибутов создается таблица `file` в стандартной схеме `public`.
  Скрипт инициализации этой таблицы находится в `db.changelog-1.0.sql`.
  * Второй скрипт `db.changelog-2.0.sql` инициализирует 15 сущностей в описанной выше таблице, для 
  упрощения проверки рабоспособности сервиса и прохождения тестов.

### Сервис

- Все основные компоненты сервиса расположены в директории `src/main/java/com/hottabych04/app`.
  * В данной директории находится класс `ApplicationRunner` помеченный `@SpringBootApplication`,
  реализующий метод `main`.
  * В пакете `database.entity` хранится класс сущности `File` которая содержит в себе аттрибуты файла и его
  данные. (Было принято решение - аудитинг к данной сущности не применять, так как в приложении отсутствуют
  методы для изменения сущности).
  * В пакете `database.repository` хранится интерфейс `FileRepository<File, Long>` унаследованный от 
  `JpaRepository`. Благодаря чему все методы для запросов в БД инициализируются автоматически при помощи 
  Spring Data JPA.
  * Для работы на слоях выше репозиториев был создан DTO класс `FileDto` лежащий в пакете `dto` и повторяющий
  все поля класса `File` за исключением поля `id`. 
  * Для преобразования `FileDto` и `File` были созданы классы `ReadFileMapper` и `SaveFileMapper` наследованные 
  от написанного интерфейса `Mapper<F, T>` где `F` - From, `T` - To. В них реализован единственный метод 
  `T map(F object)`. Находятся эти классы в пакете `mapper`.
  * Класс `FileService` представляющий собой слой сервисов находится в пакете `service`. Данный класс 
  выполняет связующую функцию между слоем репозиториев и контроллеров при помощи зависимостей. Выполняет методы 
  для запросов в БД и преобразовывает входные и выходные данные в нужные форматы.
  * Класс `FileController` лежащий в пакете `http.controller` реализует слой контроллеров, и занимается обработкой 
  http запросов. Реализовано три эндпоинта которые отвечают за методы создания, получения по айди и получения 
  всех файлов.
  * В `src/main/resources/application.yml` указаны параметры для Spring.

### Тесты

- Все компоненты необходимые для тестов находятся в директории `src/test/java/com/hottabych04/app/integration`.
  * В пакете `annotation` находится аннотация `@IT` которая помечена аннотациями `@SpringBootTest`
  и `@ActiveProfiles("test")`. Данная аннотация нужна для применения сразу двух других аннотаций к классу 
  которыми она помечена.
  * В директории со всемии остальными компонентами находится абстрактный класс `IntegrationTestBase` который
  инициализирует новый контейнер в докере с БД для тестов, а так же помечен `@IT`. Все интеграционные тесты 
  унаследованы от этого класса.
  * В пакетах `database`, `mapper` и `service` содержатся классы для интеграционного тестирования 
  реализованных методов в исходных классах при помощи Mock объектов.
  * Класс `FileRepositoryIT` реализует юнит тесты методов `FileRepository` класса с запросами в тестовую БД.
  Параметры подключения к тестовой БД указаны в `src/test/resources/application-test.yml`, где приставка
  `-test` в названии файла означает применение параметров из этого файла только в случае активации профиля 
  `test`, что и происходит в `@IT`.
  * Класс `FileControllerIT` который находится в пакете `http.controller` реализует интеграционное 
  тестирование класса `FileController` при помощи `MockMvc`.
  
## Иструкция по запуску приложения

**Для запуска сервиса необходим Docker и плагин docker-compose**

Инструкция:
1. Скачиваем zip-архив репозитория и распаковываем его в необходимое место. Или клонируем репозиторий
   (необходим установленный git в системе):
    ```
    git clone https://github.com/hottabych04/File-base64-Storage-Service.git
    ```

2. Переходим в директорию архива:
    ```
    cd File-base64-Storage-Service-master/src/main/docker
    ```
   
3. Запускаем инициализацию необходимых контейнеров в Docker:
    ```
    docker-compose up
    ```
   
**Готово!**

Теперь наш сервис доступен на порту 8080, куда можно отправлять http запросы.

## Примеры запросов

1. Для сохранения файла необходимо отправлять PUT запрос по 
адресу http://localhost:8080/api/v1/files/save с телом запроса JSON следующего формата:
```
{
    "title": "testFile16",
    "description": "description16",
    "creationDate": "2007-11-21T18:37:56",
    "data": "dkgiemitmiwjt09kjoi4tjskldmrt90w3j46oitlr4kmskletm0erhy9ejr90hkopm50qw9tk0q3m4yt0er9ky0rmphom500w9ymh4mimhtrkmwyoi[0sy5"
}
```
после чего, в случае успеха, сервис вернет ответ JSON формата с номером `id` новой сущности 
и статусом `201 Created`.

2. Для получения файла по `id` необходимо отправить GET запрос по адресу
http://localhost:8080/api/v1/files/get/{id}, где вместо `{id}` указать `id` файла который вы желаете получить.
В случае успеха, сервер вернет статус код `200 Ok` и ответ JSON следующего формата:
```
{
    "title": "testFile16",
    "description": "description16",
    "creationDate": "2007-11-21T18:37:56",
    "data": "dkgiemitmiwjt09kjoi4tjskldmrt90w3j46oitlr4kmskletm0erhy9ejr90hkopm50qw9tk0q3m4yt0er9ky0rmphom500w9ymh4mimhtrkmwyoi[0sy5"
}
```

3. Для получения всех файлов постранично, необходимо отправить GET запрос по адресу
   http://localhost:8080/api/v1/files/get/page/{page}, где вместо `{page}` указать страницу которую вы желаете получить.
   В случае успеха, сервер вернет статус код `200 Ok` и ответ JSON следующего формата:
```
[
    {
        "title": "testFile4",
        "description": "description4",
        "creationDate": "1999-01-30T23:37:12",
        "data": "t1340jgm4pokmok1mfme3090f1k3409fkgl4kmf1okmmkodmflkmdam90rkgf0-m2img"
    },
    {
        "title": "testFile12",
        "description": "description12",
        "creationDate": "2000-07-24T14:58:20",
        "data": "24562905uj90jroifmglksmfdlkmgkm35409yhkpowklwpk';lwelmwkrnywnkjgnwflkjngifxucbx7cvb9i20495ikypoglkenmrtglkjwnkjnbrgw"
    },
    {
        "title": "testFile7",
        "description": "description7",
        "creationDate": "2005-10-07T11:35:45",
        "data": "1t48hj8jrajonfgkdjasnvkjbnkjfsdanvgnmefokmglkwejrkgjeiojg89p952hjp98htrkjngskjlnfgkjnfsdjnguinas89fghj982j45nkj26nkj245ni4fjg9s8ahj"
    },
    {
        "title": "testFile11",
        "description": "description11",
        "creationDate": "2009-10-11T10:50:48",
        "data": "rew90ug90rjogijrknwkmrkmgmffb90cvx0b890vc8xbuioj254knmlkmwkmtkornimwkpfokgpo[xf9ig0ue"
    },
    {
        "title": "testFile13",
        "description": "description13",
        "creationDate": "2013-03-31T21:45:32",
        "data": "gwer-90gk90iwkf0kgowjglkmknnvzvkbmncvxmbcxvbkpxcovkbkjxcvoibop[i[0oriet-9we0rti09u24j23nktjnrknnmgjfoijsdgf"
    }
]
```